#!/bin/bash
hubert_id=`docker ps -a -f name=hubert_hubert_1 --format "{{.ID}}"`
echo "Starting Cassandra container ..."
docker start hubert_cassandra_1

echo "Starting RabbitMQ container ..."
docker start hubert_rabbitmq_1

echo "Waiting for Cassandra container to become available ..."
wait_cassandra ()
{
  wait_seconds=5
  # Seed Cassandra with the necessary tables
  check_online=`docker run -it --link hubert_cassandra_1:cassandra --rm hubert_cassandra sh -c 'exec cqlsh "$CASSANDRA_PORT_9042_TCP_ADDR" -e "use hubert;"'`
  echo $check_online
  if echo "$check_online" | grep -q "error"; then
    echo "Container not ready, waiting $wait_seconds seconds ...";
    sleep $wait_seconds;
    wait_cassandra
    return
  else
    echo "Cassandra ready ...";
    echo "Starting Hubert container ..."
    if [ -n "$hubert_id" ]; then
      docker start hubert_hubert_1
    else
      docker run --name hubert_hubert_1 -it \
        --link hubert_cassandra_1:cassandra \
        --link hubert_rabbitmq_1:hubert \
        --env NODE_ENV=production \
        hubert_hubert:latest npm start
    fi
  fi
}
wait_cassandra

echo "Starting Learning container ..."
# @todo - This needs to be run via cronjob or something similar
# docker run -it --name hubert_learn_1 --link hubert_cassandra_1:cassandra --link hubert_rabbitmq_1:hubert.rabbitmq hubert_learn:latest
